# Build v Buy for Fine-Grained RBAC

## Buy Options

* WorkOS
* Okta

| **Features**                                   | **Workos**                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | **Okta**                                                                                                                                                                                                                                                                                                                                                                                                                             |
| ---------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| Unique Benefits                                | WorkOS is a set of building blocks for quickly adding enterprise features to your app. You’ll be shipping quickly with a market-proven solution for your customers.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Simplified SSO solution unifying Azure/AWS and multiple third party vendors                                                                                                                                                                                                                                                                                                                                                          |
| User Experience                                | [https://workos.com/docs/user-management/authkit](https://workos.com/docs/user-management/authkit) AuthKit a very clean package for building auth                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   | Brandable, simple self-service, reviews note Okta’s ease-of-use overall.                                                                                                                                                                                                                                                                                                                                                             |
| IdP Support                                    | SAML, OIDC, SCIM                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Social login, SAML 2.0, Smart Card (not useful for our purposes but interesting), generic OIDC.                                                                                                                                                                                                                                                                                                                                      |
| MFA                                            | topt and sms                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | “You can require authenticators for apps or groups of users and specify which ones can be used for account recovery.”<br>Okta supports:<br>Email, Phone, Custom OTP, Custom Authenticator, Duo Security, Google Authenticator, Symantec VIP, YubiKey OTP, Smart Card,<br>[Okta Verify](https://help.okta.com/oie/en-us/content/topics/identity-engine/authenticators/configure-okta-verify.htm), FIDO2, Security Questions, Password |
| User Lifecycle Management                      | Users can be managed from a provided OS, and Automatic User Provisioning can be done via JIT provisioning [https://workos.com/user-management](https://workos.com/user-management)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Automations around joiners/leavers/movers, a portal for provisioning/deprovisioning. Can organize identities across multiple sources (HR resource management software, Active Directory, AWS, etc). This means an identity could be updated in HR software [retirement date/department move/etc], and Okta will automatically sync that information to update user permissions/software license provision for the employee.          |
| API-Driven                                     | Extremely.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | REST API, docs: [https://developer.okta.com/docs/reference/core-okta-api/](https://developer.okta.com/docs/reference/core-okta-api/)                                                                                                                                                                                                                                                                                                 |
| Group Management                               | Users sit within Organisations. The Organisations model is flexible, and users can be in many organisations or just the one.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        | Okta performs lifecycle management based on groups - groups can sync to match departments and domain functions.                                                                                                                                                                                                                                                                                                                      |
| Customer Identity and Access Management (CIAM) | JIT provisioning, directory sync [https://workos.com/directory-sync](https://workos.com/directory-sync)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | Furthermore, “routing rules [can be set up] to direct users to an IdP based on context, such as the user's location, device, or email domain.” - allowing us to control access for customers based on context.                                                                                                                                                                                                                       |
| B2B Collaborator Support                       | Directory sync                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Centralized user management and provisioning for third parties and partners.                                                                                                                                                                                                                                                                                                                                                         |
| Privileged Access Management (PAM) tools       | I’m not seeing any built in PAM tools                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | Privileged access governance including business controls (multi-step approval and time-bound approvals) and integration with Okta System Log to view all actions.                                                                                                                                                                                                                                                                    |
| Fine-Grained RBAC Policies                     | [https://workos.com/docs/directory-sync/identity-provider-role-assignment](https://workos.com/docs/directory-sync/identity-provider-role-assignment) group-based role assignment.<br>“Having a user who belongs to multiple groups is a common scenario. For example, there might be a case where an employee<br>_Jane_ is an _Engineering Manager_ and belongs to an “Engineering”, “Manager”, and “Admin” group. With group-based role assignment, the user will be assigned the role that has the [highest priority defined](https://workos.com/docs/(/roles/roles))”<br><br>This may result in us having to build out very specific roles. However, WorkOS has recently acquired Warrant (a FGA tool for devs). | Okta has FGA that follows the language in Google’s Zanzibar RBAC paper. [https://docs.fga.dev/modeling/configuration-language](https://docs.fga.dev/modeling/configuration-language)                                                                                                                                                                                                                                                 |
| Conditional Access                             | I haven’t found an example of this                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  | Possible to set up a a conditional access policy: [https://www.okta.com/uk/blog/2022/05/how-do-conditional-access-systems-work/](https://www.okta.com/uk/blog/2022/05/how-do-conditional-access-systems-work/)                                                                                                                                                                                                                       |
| Reporting Capabilities                         | Done via audit logs                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Realtime log, pre-built reports, exportable full system log, API queryable full system log, can integrate with Splunk, can download CSVs of events.                                                                                                                                                                                                                                                                                  |
| Auditing Capabilities                          | [https://workos.com/audit-logs](https://workos.com/audit-logs) Audit logs available and exportable. Can audit based on events.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | Early Access - can use Systems Log to audit events: [https://help.okta.com/asa/en-us/content/topics/adv_server_access/docs/audit-events-with-okta-syslog.htm](https://help.okta.com/asa/en-us/content/topics/adv_server_access/docs/audit-events-with-okta-syslog.htm)                                                                                                                                                               |
| Integration                                    | Integrates with Cognito, EntraID                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    | Integrates with **AWS IAM, Cognito, Azure**                                                                                                                                                                                                                                                                                                                                                                                          |
| Support                                        | All customers have access to [documentation](https://workos.com/docs), email support, and in-product web support. Premium support options include expert guided integration and response time SLAs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Help Center, Ask the Community, email, phone.<br>SLA:<br><br>                                                                                                                                                                                                                                                                                                                                                                        |
| Availability                                   | 99.99% [https://workos.com/changelog/99-99-availability-for-sso-directory-sync-and-audit-logs](https://workos.com/changelog/99-99-availability-for-sso-directory-sync-and-audit-logs)                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               | 99.99% in 2022                                                                                                                                                                                                                                                                                                                                                                                                                       |
| Architecture                                   | Uncertain, but Ruby on Rails and Java are two languages a lot of their senior devs have on their LinkedIn.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          | Multitenant, cell-based with sub-processor failover.                                                                                                                                                                                                                                                                                                                                                                                 |
| Adverse News                                   | n/a                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Okta breach: [https://sec.okta.com/harfiles](https://sec.okta.com/harfiles) / [https://www.wired.com/story/okta-breach-disclosure-all-customer-support-users/](https://www.wired.com/story/okta-breach-disclosure-all-customer-support-users/)                                                                                                                                                                                       |
| Pricing Model                                  | $125/connection/month for SSO, $125/connection/month for Directory Sync, $5/org/month for Audit logs…….or $125/org/month if we want those logs outside of .csv                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      | $1,500 annual contract minimum.<br><br>_Privileged Access pricing: $14/unit per month._<br>Adaptive SSO: $5/user/month<br>Adaptive MFA: $6/user/month<br>Universal Directory:<br>$2/user/month<br>Identity Governance:<br>$9/user/month<br>Lifecycle Management: $4/user/month<br>API Access Management: $2<br>Device Access: $4/user/month                                                                                          |
| Overall Cost                                   | Assuming 5 external orgs with directory sync, audit logs, and a custom domain, I got an estimated monthly bill of $1349                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             | For each employee: $30/user/month<br>For each external user: $11/user/month<br><br>**ESTIMATED: I don’t have data yet as to if some of these costs can be folded into each other. I believe we may need a quote from their sales team for that.**                                                                                                                                                                                    |
## Buy Recommendation 

* Due to the cost associated with Okta, I'd recommend we lean towards WorkOS for build efficiency and cost-effectiveness. 


## Build Option

We can also use Entra ID and Azure to set up our user permissions. In order to ensure synchronicity in a cross-cloud environment we can use the Federated Identity Pattern [/referenceLibrary/patternLibrary/federatedIdentity.md](here) to delegate authorisation to consolidate cross-cloud user management. In the case of this build option, the idea is to utilise **Azure,** specifically **Entra ID** as the user manager.

This would allow us to grant access to the data required by a user's identity while providing a cohesive experience. Entra Permissions Management operates as a Cloud Infrastructure Entitlement Management (CIEM) solution, delivering a framework for minimum access privileges. It enables users to run with a basic permission set and necessitates an approval process for temporary, need-based permission escalation. Entra provides a single interface for overseeing access across the big three cloud providers (Azure, AWS, and Google Cloud) enabling users to tackle the “permissions gap”; the discrepancy between *assigned* and *used* permissions.

Using Azure, users can be controlled programmatically using Terraform, which would offer us IaC control (Please see [/solutionsBuildingBlocks\proofOfConcepts\userControlAzure](here) for a quick PoC).

Azure offers us two ways of managing the identity here:

* System-assigned: This identity is tied directly to a specific Azure resource. When the resource 
is deleted, Azure automatically cleans up the credentials and the identity. For example, when an 
Azure app service is created, it is automatically assigned a managed identity that can be used 
to request tokens from Azure AD, and the name will be the same as the name of the service.
* User-assigned: It is also possible to create an identity as a standalone Azure resource that can be 
assigned to one or more instances of an Azure service. Unlike system-assigned, this identity isn’t 
automatically deleted when the associated resource is deleted. In this case, multiple resources 
can share the same permissions as assigned to this identity.

The big benefit of using managed identities for this use case is that they can be used across different 
applications and services. When applications need to share secrets, they can be stored centrally in a 
key vault, and managed identities can be granted access. 

### Provisioning Users

Entra allows for Cross-Tenant Synchronisation, meaning we can automatically replicate users across connected clouds, allowing for automated lifecycle management and smooth user management. Furthermore, with SCIM we can automatically provision users and permissions across both AWS and Azure.

Furthermore, we can use OpenID Connect to manage application access to the AWS cloud from Azure. On the Entra ID side, this involves the registration of an application and includes setup of a service principal. On the AWS side, it requires the establishment of a trust relationship with the registered application and creation of a web identity role.

[Entra to IAM](solutionsBuildingBlocks\modelsAndDiagrams\idDiagrams\entraToIAM.png)

### Assuming Roles

We can use step functions to automate role provision, with EventBridge on AWS listening for IAM events, filtering, and running the appropriate step function to either assign roles or delete.

[step Function Automation](solutionsBuildingBlocks\modelsAndDiagrams\idDiagrams\automatedIAM.png)

#### Security Note on Assuming Roles with OIDC
Using an OIDC principal without a condition can be overly permissive. To make sure that only the intended identities assume the role, provide an audience (aud) and subject (sub) as conditions in the role trust policy for this IAM role.

### Setting up SSO

**Steps:**
1. Within Azure Portal, create a new Enterprise Application
2. From Enterprise Application Gallery, select AWS IAM Identity Centre
3. On the Single Sign-On page, select SAML
4. Sign into AWS with an admin account
5. In IAM Identity Center, choose Settings
6. Under Identity Source, select Change Identity Source
7. Choose External Identity Provider
8. Download your AWS SAML Metadata
9. Copy the AWS access portal sign-in URL
10. Back in Azure, click the pencil icon for Basic SAML to edit
11. Paste the AWS sign-in URL in the Sign on URL section
12. Upload your AWS metadata file
13. Still on Azure, check the SAML Signing Certificate section and download your Federation Metadata XML
14. Back in AWS, in the Identity Provider Metadata section, upload the Federation Metadata XML file you downloaded from Azure.
15. Save and accept changes
16. Test users

**Notes**
If ABAC is enabled in AWS IAM Identity Center, the additional attributes may be passed as session tags directly into AWS accounts.

# Recommendation

Based on **Security** and **Auditability** I would recommend running with Entra.

At this point, comparing WorkOS and building via Azure, I would recommend Azure. Using AzureAD would give us a one-stop shop and minimise our attack surfaces (see Secure by Design principles).